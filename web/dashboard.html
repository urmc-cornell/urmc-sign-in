<!DOCTYPE html>
<html>
<head>
    <title>URMC Database Management</title>
    <!-- Styles for the HTML elements -->
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-section { 
            margin-bottom: 30px; 
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        input, button { 
            margin: 10px 0; 
            padding: 8px; 
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background-color: #45a049; }
        .message { margin-top: 10px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>URMC Database Management</h1>

        <!-- Environment Toggle -->
        <div class="form-section" id="env-toggle" style="border: 2px solid #28a745; background-color: #d4edda;">
            <h2>Environment</h2>
            <p>Currently targeting: <strong id="current-env" style="font-size: 1.2em;">production</strong></p>
            <div style="display: flex; gap: 10px;">
                <form action="/set_env" method="POST" style="flex: 1;">
                    <button type="submit" name="env" value="staging"
                            style="background-color: #ffc107; color: black;">
                        Switch to Staging
                    </button>
                </form>
                <form action="/set_env" method="POST" style="flex: 1;">
                    <button type="submit" name="env" value="production"
                            style="background-color: #28a745;">
                        Switch to Production
                    </button>
                </form>
            </div>
        </div>

        <!-- Staging Actions (only visible in staging mode) -->
        <div class="form-section" id="push-section" style="border: 2px solid #17a2b8; background-color: #d1ecf1; display: none;">
            <h2>Staging Actions</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <form action="/pull_from_production" method="POST" style="flex: 1;"
                      onsubmit="return confirm('This will copy all production data into staging. Continue?');">
                    <button type="submit" style="background-color: #17a2b8;">
                        Pull from Production
                    </button>
                </form>
                <form action="/push_to_production" method="POST" style="flex: 1;"
                      onsubmit="return confirm('Are you sure you want to push all staging data to production?');">
                    <button type="submit" style="background-color: #dc3545;">
                        Push to Production
                    </button>
                </form>
            </div>
            <p style="color: #0c5460; margin: 0; font-size: 0.9em;"><strong>Pull</strong> = copy production data into staging (to start fresh). <strong>Push</strong> = send staging changes to production.</p>
        </div>

        <div class="form-section">
            <h2>Add Events</h2>
            <form action="/add_event" method="POST">
                <input type="text" name="name" placeholder="Event Name" required>
                <input type="text" name="description" placeholder="Event Description" required>
                <select name="month" required>
                    <option value="" disabled selected>Select Month</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
                <select name="day" required>
                    <option value="" disabled selected>Select Day</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                </select>
                <input type="text" name="year" placeholder="Year" required>
                <input type="text" name="flyer_url" placeholder="Event Image Google Drive Link" required>
                <input type="text" name="insta" placeholder="Instagram Post Link (Can leave this blank if N/A)">
                <button type="submit">Process Form</button>
            </form>
        </div>
        
        <!-- Section for manual points update -->
        <div class="form-section">
            <h2>Manual Points Update</h2>
            <form action="/update_points" method="POST">
                <input type="text" name="netid" placeholder="NetID" required>
                <input type="number" name="points" placeholder="Points" required>
                <input type="text" name="reason" placeholder="Reason" required>
                <button type="submit">Update Points</button>
            </form>
        </div>

        <!-- Section for processing form responses -->
        <div class="form-section">
            <h2>Process Form Responses</h2>
            <form action="/process_form/event" method="POST">
                <input type="text" name="form_id" placeholder="Google Form ID or Link" required>
                <input type="number" name="points_value" placeholder="Points per response" required>
                <button type="submit">Process Form</button>
            </form>
        </div>

        <div class="form-section">
            <h2>Add E-board Members</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button type="button" id="eboard-form-btn" onclick="toggleEboardSource('form')"
                        style="flex: 1; background-color: #4CAF50; color: white;">Google Form</button>
                <button type="button" id="eboard-sheet-btn" onclick="toggleEboardSource('sheet')"
                        style="flex: 1; background-color: #ddd; color: #333;">Google Sheet</button>
            </div>
            <form id="eboard-form" action="/process_form/eboard" method="POST">
                <input type="text" name="form_id" placeholder="Google Form ID or Link" required>
                <button type="submit">Process Form</button>
            </form>
            <form id="eboard-sheet" action="/process_sheet/eboard" method="POST" style="display: none;">
                <input type="text" name="sheet_id" placeholder="Google Sheet ID or Link" required>
                <button type="submit">Process Sheet</button>
            </form>
        </div>

        <div class="form-section">
            <h2>Add TAs</h2>
            <form action="/process_form/ta" method="POST">
                <input type="text" name="form_id" placeholder="Google Form ID or Link" required>
                <button type="submit">Process Form</button>
            </form>
        </div>

        <!-- Logout button -->
        <div class="form-section">
            <form action="/logout" method="GET">
                <button type="submit" style="background-color: #f44336;">Logout</button>
            </form>
        </div>

    </div>

    <script>
        fetch('/get_env')
            .then(r => r.json())
            .then(data => {
                const envLabel = document.getElementById('current-env');
                const toggle = document.getElementById('env-toggle');
                const pushSection = document.getElementById('push-section');
                envLabel.textContent = data.env;
                if (data.env === 'staging') {
                    toggle.style.backgroundColor = '#fff3cd';
                    toggle.style.borderColor = '#ffc107';
                    pushSection.style.display = 'block';
                } else {
                    toggle.style.backgroundColor = '#d4edda';
                    toggle.style.borderColor = '#28a745';
                    pushSection.style.display = 'none';
                }
            });

        fetch('/get_message')
            .then(r => r.json())
            .then(data => {
                if (data.message) {
                    const MAX_PREVIEW = 150;
                    const isError = data.message.toLowerCase().startsWith('error');
                    const bgColor = isError ? '#f8d7da' : '#d4edda';
                    const textColor = isError ? '#721c24' : '#155724';
                    const borderColor = isError ? '#f5c6cb' : '#c3e6cb';

                    const banner = document.createElement('div');
                    banner.style.cssText = `padding: 12px 20px; margin-bottom: 20px; border-radius: 8px; font-weight: bold;
                        background-color: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor}; position: relative;`;

                    // Close button
                    const closeBtn = document.createElement('span');
                    closeBtn.textContent = '\u00d7';
                    closeBtn.style.cssText = 'position: absolute; top: 8px; right: 12px; cursor: pointer; font-size: 1.4em; line-height: 1;';
                    closeBtn.onclick = () => banner.remove();
                    banner.appendChild(closeBtn);

                    if (data.message.length > MAX_PREVIEW) {
                        // Truncated preview
                        const preview = document.createElement('span');
                        preview.textContent = data.message.substring(0, MAX_PREVIEW) + '...';
                        banner.appendChild(preview);

                        // Toggle link
                        const toggle = document.createElement('span');
                        toggle.textContent = ' Show more';
                        toggle.style.cssText = `cursor: pointer; text-decoration: underline; font-weight: normal; margin-left: 4px; color: ${textColor};`;
                        banner.appendChild(toggle);

                        // Full message (hidden by default)
                        const full = document.createElement('div');
                        full.textContent = data.message;
                        full.style.cssText = 'display: none; margin-top: 8px; font-weight: normal; white-space: pre-wrap; word-break: break-word;';
                        banner.appendChild(full);

                        toggle.onclick = (e) => {
                            e.stopPropagation();
                            if (full.style.display === 'none') {
                                full.style.display = 'block';
                                preview.style.display = 'none';
                                toggle.textContent = ' Show less';
                            } else {
                                full.style.display = 'none';
                                preview.style.display = 'inline';
                                toggle.textContent = ' Show more';
                            }
                        };
                    } else {
                        const text = document.createElement('span');
                        text.textContent = data.message;
                        banner.appendChild(text);
                    }

                    document.querySelector('.container').insertBefore(banner, document.querySelector('.container').children[1]);
                }
            });
        function toggleEboardSource(source) {
            const formEl = document.getElementById('eboard-form');
            const sheetEl = document.getElementById('eboard-sheet');
            const formBtn = document.getElementById('eboard-form-btn');
            const sheetBtn = document.getElementById('eboard-sheet-btn');
            if (source === 'sheet') {
                formEl.style.display = 'none';
                sheetEl.style.display = 'block';
                sheetBtn.style.backgroundColor = '#4CAF50';
                sheetBtn.style.color = 'white';
                formBtn.style.backgroundColor = '#ddd';
                formBtn.style.color = '#333';
            } else {
                formEl.style.display = 'block';
                sheetEl.style.display = 'none';
                formBtn.style.backgroundColor = '#4CAF50';
                formBtn.style.color = 'white';
                sheetBtn.style.backgroundColor = '#ddd';
                sheetBtn.style.color = '#333';
            }
        }
    </script>
</body>
</html>